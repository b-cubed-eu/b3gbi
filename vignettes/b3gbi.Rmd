---
title: "A Gentle Introduction to b3gbi: Data Cubes to Biodiversity Indicators"
author: "Shawn Dove"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{A Gentle Introduction to b3gbi: Data Cubes to Biodiversity Indicators}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 8,
  fig.height = 6,
  out.width = "95%"
)

```

## Introduction üåç

The goal of the **b3gbi** package (B3 General Biodiversity Indicators) is to provide standardized, automated, and reproducible workflows for calculating essential spatial and temporal biodiversity indicators. Developed as part of the EU-funded B3 (Biodiversity Building Blocks for Policy) project, b3gbi takes pre-processed GBIF occurrence cubes as input and quickly transforms them into actionable metrics, complete with integrated uncertainty estimation using robust bootstrapping methods.

This tutorial will guide you through the three core steps of the b3gbi workflow:

1. **Data Ingestion**: Preparing your GBIF data cube with `process_cube()`.
2. **Indicator Calculation**: Using indicator-specific wrapper functions.
3. **Visualization**: Plotting the results as maps or time series using the generic `plot()` function.

The package is publicly available at <https://www.github.com/b-cubed-eu/b3gbi>.

## Package Installation

The package is available on the dedicated B-Cubed R-universe repository.

```{r install, eval = FALSE}
# Install the package from the dedicated R-universe
install.packages("b3gbi", repos = "https://b-cubed-eu.r-universe.dev")

# Load the package
library(b3gbi)
```

```{r load, echo = FALSE}
library(b3gbi)
```

## Step 1: Data Ingestion with `process_cube()`

The first step is importing your GBIF occurrence cube (a .csv file) and converting it into a structured `processed_cube` object. This function automatically validates the input and attempts to autodetect column names and grid types.

### Key `process_cube()` Arguments

| Argument | Description | Default/Details |
|----------|-------------|-----------------|
| `data` | Path to the .csv file containing the GBIF cube. Required. | |
| `grid_type` | The grid system used (e.g., 'eea', 'mgrs', 'eqdgc', 'custom'). | Autodetected if possible. |
| `first_year` | Filters the cube to start at this year. | First year in the data. |
| `last_year` | Filters the cube to end at this year. | Last year in the data. |

üí° **Note on Column Names**: The function automatically attempts to detect required columns (like cell code, year, species key). You only need to manually specify arguments like `cols_year` or `cols_cellCode` if your column names deviate from expected standards.

### Example: Import Data and Filter by Time

Here we import an example cube of mammals in Denmark, filtering the data to start from 1980.

```{r process-cube}
# Function 1: process_cube()
denmark_cube <- process_cube(system.file("extdata", 
                                         "denmark_mammals_cube_eqdgc.csv", 
                                         package = "b3gbi"),
                             first_year = 1980) # Filter the cube to start at 1980

# Printing the object shows key metadata
denmark_cube
```

The data itself is stored in a tibble within the object's `data` slot, and the rest is metadata.

```{r structure}
str(denmark_cube)
```

## Step 2: Indicator Calculation

The package provides numerous wrappers to calculate indicators as either **maps** (spatial distribution) or **time series** (temporal trends).

### Available Indicators

Use `available_indicators` to see the full list of indicators and their associated wrapper functions (e.g., `obs_richness_map`, `total_occ_ts`). 

üí° **Note**: The ANSI characters around the indicator titles do not appear in R. They are used to colour the titles.

```{r available-indicators}
available_indicators
```

### Core Arguments for Wrapper Functions

All indicator wrapper functions (e.g., `obs_richness_map`, `occ_turnover_ts`) share the following key arguments:

| Argument | Description | Details |
|----------|-------------|---------|
| `data` | The `processed_cube` object. Required. | |
| `level` | The geographical scale ('country', 'continent', 'world'). | Automatically retrieves boundaries. |
| `region` | The specific region name (e.g., 'Germany', 'Europe'). | Required if level is set. |
| `ci_type` | Type of bootstrap confidence interval to calculate. Only relevant for time series. | 'norm', 'basic', 'perc', 'bca', or 'none'. Defaults to 'norm' for time series. |
| `num_bootstrap` | Number of bootstrap runs for CI calculation. Only relevant for time series. | Defaults to 100. |
| `first_year` | Narrow the time range for this specific calculation. | Defaults to the cube's start year. |

‚ö†Ô∏è **Important Note on Confidence Intervals (CIs)**:

- The `ci_type` argument is only used for calculating uncertainty in general time series indicators (e.g., `obs_richness_ts`) and is ignored for map indicators.
- For indicators based on Hill diversity (e.g., `hill_ts()`), the `ci_type` is ignored because CIs are calculated internally using the iNEXT package. However, the `num_bootstrap` argument is still required to define the number of runs for iNEXT's internal uncertainty estimation.

### Example: Observed Species Richness Map

Let's calculate the observed richness spatially, covering the period from 1980 to the end of the cube's data.

```{r richness-map}
# Calculate a gridded map of observed species richness for Denmark
# Note that ci_type is ignored for map indicators
Denmark_observed_richness_map <- obs_richness_map(denmark_cube, 
                                                   level = "country", 
                                                   region = "Denmark") 
```

The result is an `indicator_map` object (the data within it is also an `sf` object, containing geographical information).

```{r map-class}
class(Denmark_observed_richness_map)
class(Denmark_observed_richness_map$data)
```

### Example: Total Occurrences Time Series

Now, let's calculate the same indicator temporally for a trend analysis. We will use the default `ci_type = "norm"` and `num_bootstrap = 100`.

```{r richness-ts}
# Calculate a time series of total occurrences for Denmark
Denmark_total_occ_ts <- total_occ_ts(denmark_cube, 
                                                 level = "country", 
                                                 region = "Denmark", 
                                                 ci_type = "norm", # Include confidence intervals
                                                 num_bootstrap = 100) # Using the default number of runs
```

The result is an `indicator_ts` object.

```{r ts-class}
class(Denmark_total_occ_ts)
```

## Step 3: Visualization with `plot()`

The generic `plot()` function automatically calls the appropriate helper function (`plot_map()` or `plot_ts()`) and applies smart defaults for titles, colors, and layout.

### Plotting the Map

| Argument | Description | Common Use |
|----------|-------------|------------|
| `title` | Sets the plot title. | e.g., "Observed Richness in Denmark" |
| `legend_title` | Sets the legend title. | e.g., "Number of Species" |
| `crop_to_grid` | If TRUE, the map edges are determined by the grid extent. | |
| `surround` | If FALSE, hides surrounding countries. | |

```{r plot-map}
# Plotting the map object
plot(Denmark_observed_richness_map, 
     legend_title = "Mammal Species Count",
     title = "Observed Mammal Richness (1980-Present)")
```

### Plotting the Time Series

| Argument | Description | Common Use |
|----------|-------------|------------|
| `smoothed_trend` | If TRUE, displays a smoothed trend line (LOESS). | Defaults to TRUE. |
| `linecolour` | Sets the color of the indicator line/points. | e.g., "darkgreen" |
| `ribboncolour` | Sets the color of the confidence interval ribbon. | e.g., "lightgreen" |
| `x_label` / `y_label` | Custom labels for the axes. | |

```{r plot-ts}
# Plotting the time series object
plot(Denmark_total_occ_ts, 
     title = "Temporal Trend of Total Mammal Occurrences in Denmark",
     linecolour = "blue",
     ribboncolour = "skyblue",
     trendlinecolour = "darkorange",
     envelopecolour = "orange",
     smoothed_trend = TRUE)
```
